#include <stdio.h>

bool IsInsideVMWare()
{
  bool rc = true;
  char vm[] = "VMXh";
  char port[] = "VX";
  char out[] = "ges";

  try
  {
    asm("push %edx");
    asm("push %ecx");
    asm("push %ecx");
    asm("push %ebx");
    asm("push %ebx");
    
    __asm__("mov %[in1], %%eax": : [in1]"r" (vm));
    asm("mov %ebx, 0");//any value but not the MAGIC VALUE
    asm("mov %ecx, 10");// get VMWare versiond
    __asm__("mov %[in1], %%eax": : [in1]"r" (port));

    asm("in %eax, dx");//read port

    asm("cmp %%eax, %[in1]": : [in1]"r" (vm));// is it a replay from VMWare
    asm("setz %[in1]": : [in1]"r" (rc));//set return value
    
    asm("pop %ebx");
    asm("pop %ecx");
    asm("pop %edx");

  }
  catch(void)
  {
    printf("what the fuck");
    rc = false;
  }

  return rc;
}

int main() {
    if(IsInsideVMWare()){
      printf("vm");
    }else{
      printf("no vm");
    }
    //sleep(2000);
    return 0 ;
}

