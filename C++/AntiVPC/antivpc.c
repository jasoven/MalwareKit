#include <windows.h>
#include <stdio.h>
#include <exception>

// IsInsideVPC's exception filter
DWORD inline IsInsideVPC_exceptionFilter(LPEXCEPTION_POINTERS ep)
{
  PCONTEXT ctx = ep->ContextRecord;

  ctx->Ebx = -1; // Not running VPC
  ctx->Eip += 4; // skip past the "call VPC" opcodes
  return EXCEPTION_CONTINUE_EXECUTION; // we can safely resume execution since we skipped faulty instruction
}

// high level language friendly version of IsInsideVPC()
bool IsInsideVPC()
{
  bool rc = false;

  try
  {
    asm("push %ebx");
    asm("mov %edx, 0");// Flag
    asm("mov %eax, 1");// VPC function number

    // call VPC 
    asm("__emit 0Fh");
    //_asm __emit 3Fh
    //_asm __emit 07h
    //_asm __emit 0Bh

    //_asm test ebx, ebx
    //_asm setz [rc]
    //_asm pop ebx
  }
  catch(...){}
  // The except block shouldn't get triggered if VPC is running!!
  except(IsInsideVPC_exceptionFilter(GetExceptionInformation()))
  {
  }

  return rc;
}

int main() {
    IsInsideVPC();
    while(1){};
    return 0 ;
}

