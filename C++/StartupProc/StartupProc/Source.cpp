#include <windows.h>
#include <iostream>
#include <String>
#include <wchar.h>
#include <tchar.h>

using namespace std;

#define RUN_KEY L"SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run"

int addRunEntry();

int main()
{
	//cout << pBuf << "   " << endl;
	addRunEntry();
	cin.get();
	cin.get();
	return 0;
}

int addRunEntry()
{
	CHAR path[MAX_PATH];
	int bytes = GetModuleFileNameA(NULL, path, MAX_PATH);
	TCHAR szPath[MAX_PATH];
	DWORD pathLen = 0;

	int size = strlen(path) + 1;
	wchar_t* dirName = new wchar_t[size];

	size_t outSize;
	mbstowcs_s(&outSize, dirName, size, path, size - 1);

	_tcscpy(szPath, dirName);
	pathLen = _tcslen(szPath);
	HKEY newValue;

	if (RegOpenKey(HKEY_CURRENT_USER,TEXT("Software\\Microsoft\\Windows\\CurrentVersion\\Run"),&newValue) != ERROR_SUCCESS) {return -1;}
	DWORD pathLenInBytes = pathLen * sizeof(*szPath);
	if (RegSetValueEx(newValue,TEXT("mu_service"),0,REG_SZ,(LPBYTE)szPath,pathLenInBytes) != ERROR_SUCCESS){
		RegCloseKey(newValue);
		return -1;
	}

	RegCloseKey(newValue);
	return TRUE;
}