#include "curl.h"
#include <wininet.h>
#include <tchar.h>
#include <string>
#include "HttpLib.h"
#include <iostream>

using namespace std;

wstring s2ws(string inString){
	wstring wString;
	return wString.assign(inString.begin(), inString.end());
}

// keys[] - an array of strings naming the variables in the query
// values[] - an array of strings containing the values of the variables in the query
// arrayLen - we of course need to pass the length of the above arrays
// *output[] - a pointer to a char[], where we will allocate memory and place the query string
void convertArgsToStr(string keys[], string values[], int arrayLen, char** output){
	// use this variable size string to construct the query
	string query = "";

	if (arrayLen > 0)
		query += "?";
	for (int i = 0; i < arrayLen; i++){
		query += keys[i];
		query += "=" + values[i];
		if (i < arrayLen - 1)
			query += "&";
	}
	// initialize the array pointer that was passed in to fit the query string created plus space for \0
	*output = new char[query.length() + 1];
	// copy the string to the new array pointer 
	strncpy_s(*output, strlen(query.c_str()) + 1, query.c_str(), _TRUNCATE);
}

string httpGetRequest(string url, string api, int port, char* args){
	// string variable to store the response from the server
	string response = "";
	// append the query string '?args=value..." to the end of the url
	wstring wapi = s2ws(api) + s2ws(args);

	HINTERNET hInternet = InternetOpenW(L"MyUserAgent", INTERNET_OPEN_TYPE_DIRECT, NULL, NULL, 0);

	if (hInternet == NULL)
	{
		cout << "InternetOpenW failed with error code " << GetLastError() << endl;
	}
	else
	{
		HINTERNET hConnect = InternetConnectW(hInternet, s2ws(url).c_str(), port, NULL, NULL, INTERNET_SERVICE_HTTP, 0, NULL);

		if (hConnect == NULL)
		{
			cout << "InternetConnectW failed with error code " << GetLastError() << endl;
		}
		else
		{
			const wchar_t* parrAcceptTypes[] = { L"text/*", NULL };
			HINTERNET hRequest = HttpOpenRequestW(hConnect, L"GET", wapi.c_str(), NULL, NULL, parrAcceptTypes, 0, 0);

			if (hRequest == NULL)
			{
				cout << "HttpOpenRequestW failed with error code " << GetLastError() << endl;
			}
			else
			{
				LPCWSTR hdrs = L"Content-Type: application/x-www-form-urlencoded";

				BOOL bRequestSent = HttpSendRequestW(hRequest, hdrs, wcslen(hdrs), NULL, 0);

				if (!bRequestSent)
				{
					cout << "HttpSendRequestW failed with error code " << GetLastError() << endl;
				}
				else
				{
					const int nBuffSize = 1024;
					char buff[nBuffSize];

					BOOL bKeepReading = true;
					DWORD dwBytesRead = -1;

					while (bKeepReading && dwBytesRead != 0)
					{
						bKeepReading = InternetReadFile(hRequest, buff, nBuffSize, &dwBytesRead);
						response.append(buff, dwBytesRead);
					}
				}
				InternetCloseHandle(hRequest);
			}
			InternetCloseHandle(hConnect);
		}
		InternetCloseHandle(hInternet);
	}

	return response;
}

string httpPostRequest(string url, string api, int port, char *args){
	string response = "";

	HINTERNET hInternet = InternetOpenW(L"MyUserAgent", INTERNET_OPEN_TYPE_DIRECT, NULL, NULL, 0);

	if (hInternet == NULL)
	{
		cout << "InternetOpenW failed with error code " << GetLastError() << endl;
	}
	else
	{
		HINTERNET hConnect = InternetConnectW(hInternet, s2ws(url).c_str(), port, NULL, NULL, INTERNET_SERVICE_HTTP, 0, NULL);

		if (hConnect == NULL)
		{
			cout << "InternetConnectW failed with error code " << GetLastError() << endl;
		}
		else
		{
			const wchar_t* parrAcceptTypes[] = { L"text/*", NULL };
			HINTERNET hRequest = HttpOpenRequestW(hConnect, L"POST", s2ws(api).c_str(), NULL, NULL, parrAcceptTypes, 0, 0);

			if (hRequest == NULL)
			{
				cout << "HttpOpenRequestW failed with error code " << GetLastError() << endl;
			}
			else
			{
				LPCWSTR hdrs = L"Content-Type: application/x-www-form-urlencoded";
			
				//char *data = "some data";

				BOOL bRequestSent = HttpSendRequestW(hRequest, hdrs, wcslen(hdrs), args, strlen(args));

				if (!bRequestSent)
				{
					cout << "HttpSendRequestW failed with error code " << GetLastError() << endl;
				}
				else
				{
					const int nBuffSize = 1024;
					char buff[nBuffSize];

					BOOL bKeepReading = true;
					DWORD dwBytesRead = -1;

					while (bKeepReading && dwBytesRead != 0)
					{
						bKeepReading = InternetReadFile(hRequest, buff, nBuffSize, &dwBytesRead);
						response.append(buff, dwBytesRead);
					}
				}
				InternetCloseHandle(hRequest);
			}
			InternetCloseHandle(hConnect);
		}
		InternetCloseHandle(hInternet);
	}

	return response;
}