{% extends 'codeUI.html' %}

{% load staticfiles %}

{% block title %}{{ title }}{% endblock %}

{% block js %}
<script>

function setHeader(){
  var selectedFunc = document.getElementById("function-name").value;
  var funcList = document.getElementById("function-list").children;
  for(i = 0; i < funcList.length; i++){
    if(funcList[i].value == selectedFunc){
      document.getElementById('header-text').value = funcList[i].getAttribute('header');
    }
  }
}

function getFeature(){
  var feature_name = $("#feature-name").val();
  if(feature_name != ""){
        var feat = {
          "name": feature_name,
        };

        var csrftoken = getCookie('csrftoken');
        $.ajax({
          type:"GET",
          beforeSend: function (request)
          {
            request.setRequestHeader("X-CSRFToken", csrftoken);
          },
          url: "/malware_toolkit/api/feature",
          data: feat,
          success: function(msg) {
            feat = JSON.parse(msg)
            priority = feat.priority
            type = feat.type
            body = feat.body
            setElementText("#priority-text", priority.toString());
            setElementText("#type-text", type);
            setElementText("#body-text", body);
          }
        });
  }
}

function deleteFeature(){
  var del = confirm("Are you sure you want to permanently delete this feature?");
  if(del){
    var feature_name = $("#feature-name").val();
    var feat = {
      "name": feature_name,
    };

    var csrftoken = getCookie('csrftoken');
    $.ajax({
      type:"DELETE",
      beforeSend: function (request)
      {
        request.setRequestHeader("X-CSRFToken", csrftoken);
      },
      url: "/malware_toolkit/api/feature",
      data: JSON.stringify(feat),
      success: function(msg) {
        if(msg == 200){
          $("#feature-name").val("");
          $("#body-text").val("");
          $("#priority-text").val("1");
          $("#type-text").val("");

          removeFromListByName("feature_list", feat['name']);
        }
      }
    });
  }
}

function addUpdateFeature(){
  var feature_name = $("#feature-name").val();
  var body = $("#body-text").val();
  var priority = $("#priority-text").val();
  var type = $("#type-text").val();

  if(feature_name != "" && body != ""
      && priority != ""){
        body = makeArray(body);

        var feat = {
          "name": feature_name,
          "body": body,
          "priority": priority,
          "type": type
        };

        var csrftoken = getCookie('csrftoken');
        $.ajax({
          type:"POST",
          beforeSend: function (request)
          {
            request.setRequestHeader("X-CSRFToken", csrftoken);
          },
          url: "/malware_toolkit/add_feature/",
          data: JSON.stringify(feat),
          processData: false,
          success: function(msg) {
            // console.log(msg);
          }
        });
  }
}

$(document).ready(function(){
  document.getElementById('submit-btn').addEventListener('click', addUpdateFeature);
  document.getElementById('feature-delete-btn').addEventListener('click', deleteFeature);
  document.getElementById('feature-name').addEventListener('input', getFeature);
  document.getElementById('function-name').addEventListener('input', setHeader);
});

</script>
{% endblock %}

{% block banner %}{{ title }}{% endblock %}

{% block body_block %}
  <div id="top-wrapper">

    <a href="/malware_toolkit/functions">Functions</a>

    <div style="clear: both"></div>

    <div id="row-1">
      <div id="row-1-c1" style="float: left">
        Feature:</br>
        <input list="feature_list" id="feature-name">
          <datalist id="feature_list">
            {% for f in features %}
              <option value="{{ f }}"></option>
            {% endfor %}
          </datalist>
        </option>
      </div>
      </br>
      <div id="row-1-c2" style="float: left">
        <button>Add</button>
      </div>
      <div id="row-1-c3" style="float: left">
        <button id="feature-delete-btn">Delete</button>
      </div>
    </div>
    <div style="clear: both"></div>
    <!-- close row-1 -->

    <div id="row-2">
      <div id="row-2-c1" style="float: left">
        Function:</br>
        <input list="function-list" id="function-name">
          <datalist id="function-list">
            {% for func in functions %}
              <option value="{{ func.name }}" header="{{ func.header }}"></option>
            {% endfor %}
          </datalist>
        </input>
      </div>
    </div>
    <div style="clear: both"></div>
    <!-- close row-2 -->

    <div id="row-3">
      Function Header:</br>
      <input list="header-list" id="header-text"
        style="background: lightgray; width: 350px">
        <datalist id="header-list">
          {% for i, v in headers.items %}
            <option id="{{ i }}" value="{{ v }}"></option>
          {% endfor %}
        </datalist>
      </input>
    </div>
    <!-- close row-3 -->

    <div id="row-4">
      Code in Body:</br>
      <textarea id="body-text" rows="15" cols="50"></textarea>
    </div>
    <!-- close row-4 -->

    <div id="row-5">
      Priority:</br>
      <input id="priority-text" cols="40" value="1"></input>
    </div>
    <!-- close row-5 -->

    <div id="row-6">
      Feature type:</br>
      <input id="type-text" cols="40"></input>
    </div>
    <!-- close row-6 -->

    <div id="row-7">
      <button id="submit-btn">Submit</button>
    </div>
    <!-- close row-7 -->

  </div>
  <!-- close top-wrapper -->
{% endblock %}
