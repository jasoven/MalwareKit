{% extends 'base.html' %}

{% load staticfiles %}

{% block title %}{{ title }}{% endblock %}

{% block js %}
<script>
// (function(){console.log("test");})();

function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie != '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function makeArray(data){
  var array = data.split("\n");
  for(var i = 0; i < array.length; i++){
    // if the element is an empty string, remove it
    if(array[i].length == 0){
      array.splice(i, 1);
      i--;
    }
  }
  return array;
}

function sendNewFunction(){
  var function_name = $("#function-name").val();
  var imports = $("#imports-text").val();
  var declaration = $("#declaration-text").val();
  var definition = $("#definition-text").val();

  if(function_name != "" && imports != ""
      && declaration != "" && definition != ""){
      // if(true){
        imports = makeArray(imports);
        declaration = makeArray(declaration);
        definition = makeArray(definition);

        var func = {
          "name": function_name,
          "import": imports,
          "declaration": declaration,
          "definition": definition
        };
        console.log(JSON.stringify(func));

        var csrftoken = getCookie('csrftoken');
        $.ajax({
          type:"POST",
          beforeSend: function (request)
          {
            request.setRequestHeader("X-CSRFToken", csrftoken);
          },
          url: "/malware_toolkit/add_function/",
          data: JSON.stringify(func),
          processData: false,
          success: function(msg) {
            console.log(msg);
          }
        });
  }
}

function setElementText(elem, lines){
  $(elem).val("");
  for(l in lines){
    $(elem).val($(elem).val() +
      lines[l] + '\n');
  }
}

function getFunction(){
  var function_name = $("#function-name").val();
  if(function_name != ""){
        var func = {
          "name": function_name,
        };

        var csrftoken = getCookie('csrftoken');
        $.ajax({
          type:"GET",
          beforeSend: function (request)
          {
            request.setRequestHeader("X-CSRFToken", csrftoken);
          },
          url: "/malware_toolkit/api/function",
          data: func,
          success: function(msg) {
            console.log(msg);
            func = JSON.parse(msg)
            imports = func.imports
            header = func.header
            definition = func.definition;
            setElementText("#imports-text", imports);
            setElementText("#declaration-text", header);
            setElementText("#definition-text", definition);
          }
        });
  }
}

$(document).ready(function(){
  $("#submit-btn").click(sendNewFunction);
  $("#function-name").change(getFunction);
});


</script>
{% endblock %}

{% block banner %}{{ title }}{% endblock %}

{% block body_block %}
  <div id="top-wrapper">

    <div style="clear: both"></div>

    <div id="row-1">
      <div id="row-1-c1" style="float: left">
        Function:</br>
        <input list="function-list" id="function-name">
        <datalist id="function-list">
          {% for func in functions %}
            <option value="{{ func }}">
          {% endfor %}
        </datalist>
      </div>
      </br>
      <div id="row-1-c2" style="float: left">
        <button>Add</button>
      </div>
      <div id="row-1-c3" style="float: left">
        <button>Delete</button>
      </div>
    </div>
    <div style="clear: both"></div>
    <!-- close row-1 -->

    <div id="row-2">
      Imports:</br>
      <textarea id="imports-text" rows="5" cols="40"></textarea>
    </div>
    <!-- close row-2 -->

    <div id="row-3">
      Declaration:</br>
      <textarea id="declaration-text" rows="5" cols="40"></textarea>
    </div>
    <!-- close row-3 -->

    <div id="row-4">
      Definition:</br>
      <textarea id="definition-text" rows="8" cols="40"></textarea>
    </div>
    <!-- close row-4 -->

    <div id="row-5">
      <button id="submit-btn">Submit</button>
    </div>
    <!-- close row-5 -->

  </div>
  <!-- close top-wrapper -->
{% endblock %}
