{% extends 'base.html' %}

{% load staticfiles %}

{% block title %}{{ title }}{% endblock %}

{% block js_1 %}
<style>.error {
    width:200px;
    height:20px;
    height:auto;
    position:absolute;
    left:50%;
    margin-left:-100px;
    bottom:10px;
    background-color: #383838;
    color: #F0F0F0;
    font-family: Calibri;
    font-size: 20px;
    padding:10px;
    text-align:center;
    border-radius: 2px;
    -webkit-box-shadow: 0px 0px 24px -1px rgba(56, 56, 56, 1);
    -moz-box-shadow: 0px 0px 24px -1px rgba(56, 56, 56, 1);
    box-shadow: 0px 0px 24px -1px rgba(56, 56, 56, 1);
}</style>
<script>

function getRadioValueByName(name){
  var ret;
  var radios = document.getElementsByName(name);
  for(i in radios){
    if(radios[i].checked){
      ret = radios[i].value;
      break;
    }
  }
  return ret;
}

function getExeConditions(){
  var vm = getRadioValueByName("detect-vm");
  var vpc = getRadioValueByName("detect-vpc");
  var debug = getRadioValueByName("detect-debugger");
  var procmon = getRadioValueByName("detect-procmon");
  var regshot = getRadioValueByName("detect-regshot");
  var other = getRadioValueByName("detect-these");

  var conds = {};
  conds.vm = vm;
  conds.vpc = vpc;
  conds.debug = debug;
  conds.procmon = procmon;
  conds.regshot = regshot;
  conds.other = other;

  console.log(conds);
}

function sendBuildRequest(){
  var csrftoken = getCookie('csrftoken');
  var data = getUsersFeatureSelections();
  console.log(data);
  $.ajax({
    type:"POST",
    beforeSend: function (request)
    {
      request.setRequestHeader("X-CSRFToken", csrftoken);
    },
    url: "/malware_toolkit/api/build/",
    data: JSON.stringify(data),
    success: function(msg) {
      if(msg == 200){
        setDownloadBtnEnabled(true);
        fadeMsg("Build Successful");
      }else{
        setDownloadBtnEnabled(false);
        fadeMsg("Build Failed");
      }
    }
  });
}

function getUsersFeatureSelections(){
  var feature_selections = {};
  var groups = document.getElementsByClassName("toolkit-group");
  var group_name;
  var feature_name;
  // iterate over each group
  for(i = 0; i < groups.length; i++){
    group_name = groups[i].getAttribute("name");
    feature_selections[group_name] = [];
    var forms = groups[i].getElementsByTagName("form");

    // iterate over each form (feature) in this group
    for(j = 0; j < forms.length; j++){
      feature = forms[j].id;
      var options = forms[j].getElementsByTagName("input");

      // iterate over each radio button in this form looking for the checked one
      for(k = 0; k < options.length; k++){
        if(options[k].checked){
          feature_selections[group_name].push(feature);
        }
      }
    }
  }
  // console.log(feature_selections);
  return feature_selections;
}

function setDownloadBtnEnabled(enabled){
  $('#download-btn').prop('disabled', !enabled);
}

function fadeMsg(msg){
  //fade out after 3 seconds
  document.getElementById('msg-box').innerHTML = msg;
  $('.error').stop().fadeIn(400).delay(3000).fadeOut(400);
}

$(document).ready(function(){
  // document.getElementById('function-name').addEventListener('input', setHeader);
  document.getElementById('build-btn').addEventListener('click', sendBuildRequest);
});

</script>
{% endblock %}

{% block banner %}{{ title }}{% endblock %}

{% block body_block %}
  <div id="top-wrapper">

    <a href="/malware_toolkit/functions">Functions</a>
    <a href="/malware_toolkit/features">Features</a>

    <div style="clear: both"></div>

    <div id="row-1" class="row">
      <!-- begin column 1 -->
      <div id="row-1-c1" class="col-md-4" style="float: left; border: 1px solid black">
        <h4>{{ type_1 }}</h4>
        <div class="toolkit-group" name="{{ type_1 }}">
          {% for f in features_1 %}
            {{ f.toolkit_prompt }}:</br>
            <form action="" id="{{ f }}">
              {% for o in f.options %}
              <input type="checkbox" name="{{ f }}" value="{{ o }}">{{ o }}</input><br>
              {% endfor %}
            </form>
          {% endfor %}
        </div>
      </div>
      <!-- end column 1 -->

      <!-- begin column 2 -->
      <div id="row-1-c2" class="col-md-4" style="float: left; border: 1px solid red">
        <h4>{{ type_2 }}</h4>
        <div class="toolkit-group" name="{{ type_2 }}">
          {% for f in features_2 %}
            {{ f.toolkit_prompt }}:</br>
            <form action="" id="{{ f }}">
              {% for o in f.options %}
              <input type="checkbox" name="{{ f }}" value="{{ o }}">{{ o }}</input><br>
              {% endfor %}
            </form>
          {% endfor %}
        </div>
      </div>
      <!-- end column 2 -->

      <!-- begin column 3 -->
      <div id="row-1-c3" class="col-md-4" style="float: left; border: 1px solid green">
        <h4>{{ type_3 }}</h4>
        <div class="toolkit-group" name="{{ type_3 }}">
          {% for f in features_3 %}
            {{ f.toolkit_prompt }}:</br>
            <form action="" id="{{ f }}">
              {% for o in f.options %}
              <input type="checkbox" name="{{ f }}" value="{{ o }}">{{ o }}</input><br>
              {% endfor %}
            </form>
          {% endfor %}
        </div>
      </div>
      <!-- end column 3 -->
    </div>
    <div style="clear: both"></div>
    <!-- close row-1 -->

    <div id="row-2">
      <div id="row-2-c1" style="float: left" class="btn-group">
        <button id="clear-btn" class="btn btn-primary">Clear</button>
        <button id="build-btn" class="btn btn-primary">Build</button>
        <button id="download-btn" class="btn btn-primary" disabled>Download</button>
      </div>
    </div>
    <div style="clear: both"></div>
    <!-- close row-2 -->

    <div id='msg-box' class='error' style='display:none'></div>

  </div>
  <!-- close top-wrapper -->
{% endblock %}
