{% extends 'base.html' %}

{% load staticfiles %}

{% block title %}{{ title }}{% endblock %}

{% block js %}
<script>

function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie != '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function makeArray(data){
  var array = data.split("\n");
  for(var i = 0; i < array.length; i++){
    // if the element is an empty string, remove it
    if(array[i].length == 0){
      array.splice(i, 1);
      i--;
    }
  }
  return array;
}

function setElementText(elem, lines){
  $(elem).val("");
  for(l in lines){
    $(elem).val($(elem).val() +
      lines[l] + '\n');
  }
}

function removeFromListByName(listId, value){
  var array = document.getElementById(listId).children;
  for(i = 0; i < array.length; i++){
    if(array[i].value == value){
      document.getElementById(listId).removeChild(array[i]);
    }
  }
}

function getRadioValueByName(name){
  var ret;
  var radios = document.getElementsByName(name);
  for(i in radios){
    if(radios[i].checked){
      ret = radios[i].value;
      break;
    }
  }
  return ret;
}

function getExeConditions(){
  var vm = getRadioValueByName("detect-vm");
  var vpc = getRadioValueByName("detect-vpc");
  var debug = getRadioValueByName("detect-debugger");
  var procmon = getRadioValueByName("detect-procmon");
  var regshot = getRadioValueByName("detect-regshot");
  var other = getRadioValueByName("detect-these");

  var conds = {};
  conds.vm = vm;
  conds.vpc = vpc;
  conds.debug = debug;
  conds.procmon = procmon;
  conds.regshot = regshot;
  conds.other = other;

  console.log(conds);
}

function getFeature(){
  var feature_name = $("#feature-name").val();
  if(feature_name != ""){
        var feat = {
          "name": feature_name,
        };

        var csrftoken = getCookie('csrftoken');
        $.ajax({
          type:"GET",
          beforeSend: function (request)
          {
            request.setRequestHeader("X-CSRFToken", csrftoken);
          },
          url: "/malware_toolkit/api/feature",
          data: feat,
          success: function(msg) {
            feat = JSON.parse(msg)
            priority = feat.priority
            type = feat.type
            body = feat.body
            setElementText("#priority-text", priority.toString());
            setElementText("#type-text", type);
            setElementText("#body-text", body);
          }
        });
  }
}

function deleteFeature(){
  var del = confirm("Are you sure you want to permanently delete this feature?");
  if(del){
    var feature_name = $("#feature-name").val();
    var feat = {
      "name": feature_name,
    };

    var csrftoken = getCookie('csrftoken');
    $.ajax({
      type:"DELETE",
      beforeSend: function (request)
      {
        request.setRequestHeader("X-CSRFToken", csrftoken);
      },
      url: "/malware_toolkit/api/feature",
      data: JSON.stringify(feat),
      success: function(msg) {
        if(msg == 200){
          $("#feature-name").val("");
          $("#body-text").val("");
          $("#priority-text").val("1");
          $("#type-text").val("");

          removeFromListByName("feature_list", feat['name']);
        }
      }
    });
  }
}

function addUpdateFeature(){
  var feature_name = $("#feature-name").val();
  var body = $("#body-text").val();
  var priority = $("#priority-text").val();
  var type = $("#type-text").val();

  if(feature_name != "" && body != ""
      && priority != ""){
        body = makeArray(body);

        var feat = {
          "name": feature_name,
          "body": body,
          "priority": priority,
          "type": type
        };

        var csrftoken = getCookie('csrftoken');
        $.ajax({
          type:"POST",
          beforeSend: function (request)
          {
            request.setRequestHeader("X-CSRFToken", csrftoken);
          },
          url: "/malware_toolkit/add_feature/",
          data: JSON.stringify(feat),
          processData: false,
          success: function(msg) {
            // console.log(msg);
          }
        });
  }
}

$(document).ready(function(){
  // document.getElementById('submit-btn').addEventListener('click', addUpdateFeature);
  // document.getElementById('feature-delete-btn').addEventListener('click', deleteFeature);
  // document.getElementById('feature-name').addEventListener('input', getFeature);
  // document.getElementById('function-name').addEventListener('input', setHeader);
  document.getElementById('build-btn').addEventListener('click', getExeConditions);
});

</script>
{% endblock %}

{% block banner %}{{ title }}{% endblock %}

{% block body_block %}
  <div id="top-wrapper">

    <a href="/malware_toolkit/functions">Functions</a>
    <a href="/malware_toolkit/features">Features</a>

    <div style="clear: both"></div>

    <div id="row-1" class="row">
      <!-- begin column 1 -->
      <div id="row-1-c1" class="col-md-4" style="float: left; border: 1px solid black">
        <h4>Execution Conditions</h4>
        Detect Virtual Machine:</br>
        <form action="">
          <input type="radio" name="detect-vm" value="yes">Yes</input><br>
          <input type="radio" name="detect-vm" value="no">No</input>
        </form>
        Detect Virtual PC:</br>
        <form action="">
          <input type="radio" name="detect-vpc" value="yes">Yes</input><br>
          <input type="radio" name="detect-vpc" value="no">No</input>
        </form>
        Detect Debugger:</br>
        <form action="">
          <input type="radio" name="detect-debugger" value="yes">Yes</input><br>
          <input type="radio" name="detect-debugger" value="no">No</input>
        </form>
        Detect Process Monitor:</br>
        <form action="">
          <input type="radio" name="detect-procmon" value="yes">Yes</input><br>
          <input type="radio" name="detect-procmon" value="no">No</input>
        </form>
        Detect RegShot:</br>
        <form action="">
          <input type="radio" name="detect-regshot" value="yes">Yes</input><br>
          <input type="radio" name="detect-regshot" value="no">No</input>
        </form>
        Check for These:</br>
        <form action="">
          <input type="radio" name="check-these" value="vm-io-port">VM I/O Port</input><br>
          <input type="radio" name="check-these" value="vm-tools">VM Tools</input>
        </form>

      </div>
      <!-- end column 1 -->
      <!-- </br> -->

      <!-- begin column 2 -->
      <div id="row-1-c2" class="col-md-4" style="float: left; border: 1px solid red">
        <h4>Malware Features</h4>
        </form>
        Make Startup Process:</br>
        <form action="">
          <input type="radio" name="make-startup" value="yes">Yes</input><br>
          <input type="radio" name="make-startup" value="no">No</input>
        </form>
        Pack Executable:</br>
        <form action="">
          <input type="checkbox" name="packing" value="yes">Yes</input>
          <input type="radio" name="packing-type" value="upx">UPX</input><br>
          <input type="radio" name="packing-type" value="other">Other</input>
        </form>

        </br>
        On Failed Exec. Conditions:</br>
        <form action="">
            <input type="radio" name="on-failed" value="kill-destroy">Kill and Destroy</input><br>
            <input type="radio" name="on-failed" value="kill">Kill</input><br>
            <input type="radio" name="on-failed" value="ignore">Ignore
        </form>

      </div>
      <!-- end column 2 -->

      <!-- begin column 3 -->
      <div id="row-1-c3" class="col-md-4" style="float: left; border: 1px solid green">
        <h4>Action Sequence</h4>

        <form action="">
          <input type="radio" name="action-sequence" value="key-log">Log Keystrokes</input><br>
          <input type="radio" name="action-sequence" value="check-reg">Check Registry</input><br>
          <input type="radio" name="action-sequence" value="mod-reg">Modify Registry</input>
          <input type="radio" name="action-sequence" value="listen-for-action">Listen to Botmaster</input>
          <input type="radio" name="action-sequence" value="none">None</input>
        </form>

      </div>
      <!-- end column 3 -->
    </div>
    <div style="clear: both"></div>
    <!-- close row-1 -->

    <div id="row-2">
      <div id="row-2-c1" style="float: left" class="btn-group">
        <button id="clear-btn" class="btn btn-primary">Clear</button>
        <button id="build-btn" class="btn btn-primary">Build</button>
        <button id="download-btn" class="btn btn-primary">Download</button>
      </div>
    </div>
    <div style="clear: both"></div>
    <!-- close row-2 -->

  </div>
  <!-- close top-wrapper -->
{% endblock %}
